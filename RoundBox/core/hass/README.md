Functional code borrowed from Home-Assistant main code base
